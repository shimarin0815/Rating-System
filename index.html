<!doctype html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レーティングシステム | Single-File SPA</title>
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          boxShadow: {
            glow: '0 10px 30px rgba(59,130,246,0.25)'
          },
          backdropBlur: {
            xs: '2px',
          }
        }
      },
      darkMode: 'media'
    }
  </script>
  <style>
    html, body { height: 100%; }
    /* Fancy background */
    .bg-grid {
      background-image:
        radial-gradient(60rem 40rem at 80% -20%, rgba(96,165,250,.35), transparent 40%),
        radial-gradient(50rem 30rem at -20% 10%, rgba(192,132,252,.35), transparent 40%),
        linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.6));
    }
    @media (prefers-color-scheme: dark) {
      .bg-grid { background-image:
        radial-gradient(60rem 40rem at 80% -20%, rgba(96,165,250,.12), transparent 40%),
        radial-gradient(50rem 30rem at -20% 10%, rgba(192,132,252,.12), transparent 40%),
        linear-gradient(180deg, rgba(17,24,39,.95), rgba(17,24,39,.85)); }
    }
    .glass { background: rgba(255,255,255,.55); backdrop-filter: blur(10px); }
    @media (prefers-color-scheme: dark){ .glass{ background: rgba(31,41,55,.55);} }
    .star { transition: transform .08s ease; }
    .star:hover { transform: scale(1.12); }
    .fade-in { animation: fade .35s ease-out both; }
    @keyframes fade { from{opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;} }
  </style>
</head>
<body class="min-h-full bg-grid text-gray-900 dark:text-gray-100 antialiased">
  <div class="relative">
    <!-- Floating gradient orbs -->
    <div class="pointer-events-none absolute inset-x-0 -top-24 flex justify-center opacity-70">
      <div class="h-48 w-48 rounded-full blur-3xl bg-gradient-to-br from-blue-400/40 to-purple-400/40"></div>
    </div>
  </div>

  <header class="mx-auto max-w-6xl px-4 pt-12 pb-6">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
      <div>
        <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight leading-tight">
          レーティングシステム
        </h1>
        <p class="mt-2 text-gray-600 dark:text-gray-300 max-w-prose">
          シンプル&モダンな単一HTMLの評価アプリ。アイテムに⭐を付けて、平均を見たり並び替え・検索・エクスポートまでサクっとできます。
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <button id="exportBtn" class="glass hover:shadow-glow transition-shadow rounded-xl px-4 py-2 text-sm font-semibold border border-white/60 dark:border-white/10">
          データをエクスポート
        </button>
        <label class="glass cursor-pointer rounded-xl px-4 py-2 text-sm font-semibold border border-white/60 dark:border-white/10">
          <input id="importInput" type="file" accept="application/json" class="hidden">インポート
        </label>
        <button id="resetBtn" class="glass hover:bg-white/70 dark:hover:bg-white/10 transition rounded-xl px-4 py-2 text-sm font-semibold border border-rose-500/30 text-rose-600 dark:text-rose-300">
          全消去
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-16">
    <!-- Controls -->
    <section class="glass rounded-2xl p-4 md:p-6 border border-white/60 dark:border-white/10 shadow-lg">
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <div class="flex items-center gap-3">
          <label for="search" class="sr-only">検索</label>
          <input id="search" type="search" placeholder="検索（名前・メモ・カテゴリ）" class="w-full rounded-xl border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/40 px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div class="flex items-center gap-3">
          <label for="sort" class="sr-only">並び替え</label>
          <select id="sort" class="w-full rounded-xl border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/40 px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400">
            <option value="newest">新しい順</option>
            <option value="highest">評価が高い順</option>
            <option value="name">名前順</option>
          </select>
        </div>
        <div class="flex items-center gap-3">
          <button id="statsBtn" class="w-full rounded-xl border border-blue-500/40 text-blue-700 dark:text-blue-300 bg-white/70 dark:bg-gray-900/40 px-4 py-2 font-semibold hover:shadow-glow transition">
            統計を見る
          </button>
        </div>
      </div>
    </section>

    <!-- Add Item -->
    <section class="mt-6 glass rounded-2xl p-4 md:p-6 border border-white/60 dark:border-white/10 shadow-lg">
      <h2 class="text-xl font-bold">アイテムを追加</h2>
      <form id="addForm" class="mt-3 grid gap-3 md:grid-cols-5">
        <input required id="itemName" class="md:col-span-2 rounded-xl border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/40 px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400" placeholder="名前（例：ラーメン屋A / アプリB）" />
        <input id="itemCategory" class="rounded-xl border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/40 px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400" placeholder="カテゴリ（任意）" />
        <input id="itemNote" class="md:col-span-2 rounded-xl border border-gray-200/60 dark:border-gray-700/60 bg-white/70 dark:bg-gray-900/40 px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400" placeholder="メモ（任意）」 />
        <button class="rounded-xl bg-gradient-to-br from-blue-500 to-indigo-500 text-white font-semibold px-4 py-2 hover:shadow-glow transition">追加</button>
      </form>
    </section>

    <!-- List -->
    <section class="mt-6 grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="list"></section>

    <!-- Stats Modal -->
    <dialog id="statsDialog" class="rounded-2xl p-0 w-full max-w-xl backdrop:bg-black/50">
      <div class="glass rounded-2xl border border-white/60 dark:border-white/10 p-6">
        <div class="flex items-start justify-between">
          <h3 class="text-lg font-bold">統計</h3>
          <button class="rounded-lg px-2 py-1 hover:bg-white/60 dark:hover:bg-white/10" onclick="statsDialog.close()">閉じる</button>
        </div>
        <div id="statsBody" class="mt-3 space-y-2 text-sm"></div>
      </div>
    </dialog>
  </main>

  <footer class="mx-auto max-w-6xl px-4 pb-12 text-xs text-gray-500">
    <p>ローカル保存（ブラウザ内）。ページを閉じてもデータは残ります。
    </p>
  </footer>

  <!-- Template for an item card -->
  <template id="cardTpl">
    <article class="fade-in glass rounded-2xl p-4 border border-white/60 dark:border-white/10 shadow-lg flex flex-col justify-between min-h-48">
      <div>
        <div class="flex items-start justify-between gap-2">
          <div>
            <h3 class="font-bold text-lg name"></h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 category"></p>
          </div>
          <div class="text-xs text-gray-400 select-none timestamp"></div>
        </div>
        <p class="mt-2 text-sm note"></p>
      </div>

      <div class="mt-4">
        <div class="flex items-center gap-1" role="radiogroup" aria-label="評価">
          <!-- Stars will be injected here -->
        </div>
        <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
          <span class="avg"></span>
          <div class="flex gap-2">
            <button class="edit px-2 py-1 rounded-lg hover:bg-white/60 dark:hover:bg-white/10">編集</button>
            <button class="delete px-2 py-1 rounded-lg text-rose-600 dark:text-rose-300 hover:bg-rose-500/10">削除</button>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
    const STORAGE_KEY = 'ratingAppV1';
    let items = load();
    let filterText = '';

    const list = document.getElementById('list');
    const cardTpl = document.getElementById('cardTpl');

    // UI refs
    const search = document.getElementById('search');
    const sort = document.getElementById('sort');
    const addForm = document.getElementById('addForm');
    const statsDialog = document.getElementById('statsDialog');
    const statsBody = document.getElementById('statsBody');

    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const resetBtn = document.getElementById('resetBtn');

    // --- Data helpers ---
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
    function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } }
    function uid(){ return Math.random().toString(36).slice(2,10); }

    // --- Render ---
    function render(){
      list.innerHTML = '';
      let view = items
        .filter(it => (it.name+" "+(it.category||'')+" "+(it.note||'')).toLowerCase().includes(filterText))
        .sort((a,b)=>{
          switch(sort.value){
            case 'highest': return (avg(b)>=avg(a)) ? 1 : -1;
            case 'name': return a.name.localeCompare(b.name);
            default: return b.createdAt - a.createdAt; // newest
          }
        });

      view.forEach(it => list.appendChild(card(it)));
    }

    function card(it){
      const $ = cardTpl.content.cloneNode(true);
      $.querySelector('.name').textContent = it.name;
      $.querySelector('.category').textContent = it.category ? `#${it.category}` : '';
      $.querySelector('.note').textContent = it.note || '';
      $.querySelector('.timestamp').textContent = new Date(it.createdAt).toLocaleString();

      // Stars
      const starWrap = $.querySelector('[role="radiogroup"]');
      for(let i=1;i<=5;i++){
        const s = document.createElement('button');
        s.className = 'star p-1';
        s.setAttribute('role','radio');
        s.setAttribute('aria-checked', String(it.rating===i));
        s.setAttribute('title', `${i} / 5`);
        s.innerHTML = starSvg(i <= (it.rating||0));
        s.addEventListener('click', ()=>{
          it.rating = i;
          it.history.push({v:i, t: Date.now()});
          save(); render();
        });
        starWrap.appendChild(s);
      }

      // Avg & actions
      $.querySelector('.avg').textContent = `平均: ${avg(it).toFixed(2)} / 5（${it.history.length}件）`;
      $.querySelector('.delete').addEventListener('click', ()=>{
        if(confirm('削除しますか？')){
          items = items.filter(x=>x.id!==it.id); save(); render();
        }
      });
      $.querySelector('.edit').addEventListener('click', ()=>{
        const name = prompt('名前', it.name) || it.name;
        const category = prompt('カテゴリ', it.category||'') || it.category;
        const note = prompt('メモ', it.note||'') || it.note;
        Object.assign(it, {name, category, note}); save(); render();
      });

      return $.children[0];
    }

    function avg(it){
      if(!it.history.length) return it.rating||0;
      return it.history.reduce((s,h)=>s+h.v,0) / it.history.length;
    }

    function starSvg(active){
      return active
        ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="currentColor" class="text-yellow-400 drop-shadow"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896l-7.336 3.87 1.402-8.168L.132 9.211l8.2-1.193z"/></svg>`
        : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" class="text-gray-400"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
    }

    // --- Events ---
    addForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = document.getElementById('itemName').value.trim();
      if(!name) return;
      const category = document.getElementById('itemCategory').value.trim();
      const note = document.getElementById('itemNote').value.trim();
      items.unshift({ id: uid(), name, category, note, rating: 0, history: [], createdAt: Date.now() });
      save();
      addForm.reset();
      render();
    });

    search.addEventListener('input', ()=>{ filterText = search.value.toLowerCase(); render(); });
    sort.addEventListener('change', render);

    document.getElementById('statsBtn').addEventListener('click', ()=>{
      const total = items.length;
      const rated = items.filter(i=>i.history.length>0).length;
      const overall = items.length ? (items.reduce((s,i)=>s+avg(i),0)/items.length).toFixed(2) : '0.00';

      // Top 3
      const top = [...items].sort((a,b)=>avg(b)-avg(a)).slice(0,3);

      statsBody.innerHTML = `
        <p>アイテム数：<b>${total}</b></p>
        <p>評価済み：<b>${rated}</b></p>
        <p>全体平均：<b>${overall} / 5</b></p>
        <div class="mt-3">
          <p class="font-semibold">平均スコア Top 3</p>
          <ol class="list-decimal list-inside text-sm mt-1 space-y-1">
            ${top.map(t=>`<li>${escapeHtml(t.name)} — ${avg(t).toFixed(2)} / 5</li>`).join('')}
          </ol>
        </div>`;

      statsDialog.showModal();
    });

    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(items, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ratings-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    importInput.addEventListener('change', async ()=>{
      const file = importInput.files[0];
      if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!Array.isArray(data)) throw new Error('データ形式が不正です');
        items = data; save(); render();
        alert('インポート完了');
      }catch(err){ alert('インポートに失敗しました: '+ err.message); }
      importInput.value = '';
    });

    resetBtn.addEventListener('click', ()=>{
      if(confirm('本当に全データを消去しますか？')){
        items = []; save(); render();
      }
    });

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
    }

    // Initial render
    render();
  </script>
</body>
</html>
